<!DOCTYPE html>
<html>
  <head>
    <title>MICRO 23</title>
    <style>
      /* (Seus estilos, mantive os mesmos) */
      /* ... seu CSS permanece igual ... */
      body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
        color: #333;
        text-align: center;
        margin: 20px;
        padding: 0;
      }
      /* (todo o seu CSS continua igual, omito aqui para foco) */
      .action-buttons {
        display: none;
      }
      .col-extra {
        display: none;
      }
      form.data-form.editando input[type="text"] {
        background-color: #fff9e6;
      }
      .hidden {
        display: none;
      }
    </style>

    <script>
      // Fun√ß√£o para preencher o formul√°rio com dados da pessoa para edi√ß√£o
      function preencherFormulario(pessoa) {
        const form = document.getElementById("formCadastro");
        for (const key in pessoa) {
          const input = form.querySelector(`[name="${key}"]`);
          if (input) input.value = pessoa[key];
        }
      }

      // Mostrar o formul√°rio para cadastro (vazio)
      function mostrarFormulario() {
        const form = document.getElementById("formCadastro");
        form.reset();
        form.classList.add("show");
        form.classList.remove("editando");
        form.action = "{{ url_for('main.manage_person') }}";

        document.getElementById("salvarBtn").classList.remove("hidden");
        document.getElementById("atualizarBtn").classList.add("hidden");
        document.getElementById("mostrarCadastro").style.display = "none";

        form.scrollIntoView({ behavior: "smooth" });
      }

      // Mostrar formul√°rio no modo edi√ß√£o preenchido com os dados da pessoa selecionada
      function mostrarFormularioEdicao(cpf) {
        // Procurar a linha da tabela com o CPF
        const row = [...document.querySelectorAll("tbody tr")].find((tr) => {
          // Assumindo que CPF est√° em alguma coluna (ajuste conforme necess√°rio)
          return (
            tr.querySelector("td") &&
            tr.querySelector("td").textContent.includes(cpf)
          );
        });
        if (!row) {
          alert("Pessoa n√£o encontrada na tabela.");
          return;
        }

        // Construir objeto pessoa com dados das c√©lulas da linha
        const pessoa = {};
        const inputs = [...document.querySelectorAll("#formCadastro input")];
        const tds = row.querySelectorAll("td");

        // Mapear campos pelo √≠ndice da coluna (mesma ordem do formul√°rio)
        inputs.forEach((input, idx) => {
          pessoa[input.name] = tds[idx] ? tds[idx].textContent.trim() : "";
        });

        preencherFormulario(pessoa);

        // Ajustar formul√°rio para edi√ß√£o
        const form = document.getElementById("formCadastro");
        form.classList.add("show", "editando");
        form.action = `/update_person?cpf=${cpf}`; // Usar rota correta para update

        document.getElementById("salvarBtn").classList.add("hidden");
        document.getElementById("atualizarBtn").classList.remove("hidden");
        document.getElementById("mostrarCadastro").style.display = "none";

        form.scrollIntoView({ behavior: "smooth" });
      }

      // Cancelar e esconder formul√°rio
      function cancelarFormulario() {
        const form = document.getElementById("formCadastro");
        form.reset();
        form.classList.remove("show", "editando");
        form.action = "{{ url_for('main.manage_person') }}";
        document.getElementById("salvarBtn").classList.remove("hidden");
        document.getElementById("atualizarBtn").classList.add("hidden");
        document.getElementById("mostrarCadastro").style.display =
          "inline-block";
      }

      // Ocultar colunas extras (a partir de GESTANTE)
      function ocultarColunas() {
        document
          .querySelectorAll("th.col-extra, td.col-extra")
          .forEach((el) => {
            el.style.display = "none";
          });
      }

      // Mostrar colunas extras
      function mostrarColunas() {
        document
          .querySelectorAll("th.col-extra, td.col-extra")
          .forEach((el) => {
            el.style.display = "";
          });
      }

      // Excluir pessoa com confirma√ß√£o
      function deletePerson(cpf) {
        if (confirm("Tem certeza que deseja excluir este registro?")) {
          window.location.href = `/delete?cpf=${cpf}`;
        }
      }
    </script>
  </head>
  <body>
    <h1>Gerenciar Pessoas na Planilha</h1>

    <!-- Formul√°rio de pesquisa -->
    <form action="{{ url_for('main.index') }}" method="GET" class="search-form">
      <label for="query">Buscar por Nome, SUS ou CPF:</label>
      <input
        type="text"
        name="query"
        value="{{ request.args.get('query', '') }}"
      />
      <button type="submit">Pesquisar</button>
    </form>

    <!-- Bot√µes de controle -->
    <div class="text-center my-2">
      <button type="button" onclick="ocultarColunas()">
        Ocultar colunas extras
      </button>
      <button type="button" onclick="mostrarColunas()">
        Mostrar todas as colunas
      </button>
    </div>

    <!-- Bot√£o para exibir formul√°rio -->
    <button id="mostrarCadastro" type="button" onclick="mostrarFormulario()">
      Cadastrar nova pessoa
    </button>

    <!-- Formul√°rio de cadastro e edi√ß√£o -->
    <form
      id="formCadastro"
      action="{{ url_for('main.manage_person') }}"
      method="POST"
      class="data-form"
    >
      {% for chave in campos %}
      <label for="{{ chave }}">{{ chave }}:</label>
      <input type="text" name="{{ chave }}" required />
      {% endfor %}
      <button type="submit" id="salvarBtn">Salvar</button>
      <button type="submit" id="atualizarBtn" class="hidden">Atualizar</button>
      <button
        type="button"
        onclick="cancelarFormulario()"
        class="cancel-button"
      >
        Cancelar
      </button>
    </form>

    <!-- Tabela -->
    {% if dados and dados|length > 0 %}
    <table>
      <thead>
        <tr>
          {% set idx_gestante = campos.index('GESTANTE') if 'GESTANTE' in campos
          else -1 %} {% for chave in campos %} {% if loop.index0 >= idx_gestante
          and idx_gestante != -1 %}
          <th class="col-extra">{{ chave }}</th>
          {% else %}
          <th>{{ chave }}</th>
          {% endif %} {% endfor %}
          <th>A√á√ïES</th>
        </tr>
      </thead>
      <tbody>
        {% for linha in dados %} {% set cpf = linha.get("CPF", "") | string %}
        {% set cpf_limpo = limpar_cpf(cpf) %}
        <tr>
          {% for chave in campos %} {% if loop.index0 >= idx_gestante and
          idx_gestante != -1 %}
          <td class="col-extra">{{ linha.get(chave, "") }}</td>
          {% else %}
          <td>{{ linha.get(chave, "") }}</td>
          {% endif %} {% endfor %}
          <td>
            {% if cpf %}
            <div>
              <button
                type="button"
                onclick="mostrarFormularioEdicao('{{ cpf_limpo }}')"
              >
                ‚úèÔ∏è Editar
              </button>
              <button
                type="button"
                onclick="deletePerson('{{ cpf_limpo }}')"
                style="background-color: #dc3545; color: white"
              >
                üóëÔ∏è Excluir
              </button>
            </div>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p>Nenhum dado encontrado na planilha.</p>
    {% endif %}
  </body>
</html>
